import discord

from discord.ext import commands
from discord.ui import Modal, InputText, View, button

from variables import (
    ANSWER_IF_DUPLICATE_APP,
    ANSWER_IF_DUPLICATE_NICK,
    ANSWER_IF_CHEAT,
    ANSWER_IF_CLICKED_THE_SAME_TIME,
    CATCH_BUG_MESSAGE,
    LEADER_ROLE,
    OFICER_ROLE,
    TREASURER_ROLE
)
from .embeds import (
    access_embed, denied_embed, application_embed, start_app_embed
)
from .functions import character_lookup, has_required_role, answer_if_no_role


app_list: list = []


class RoleButton(View):
    """–ö–ª–∞—Å—Å –∫–Ω–æ–ø–∫–∏ —Ä–æ–ª–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ Discord.
    –°–æ–∑–¥–∞—ë—Ç 2 –∫–Ω–æ–ø–∫–∏. –ü–µ—Ä–≤–∞—è –¥–ª—è –≤—ã–¥–∞—á–∏ —Ä–æ–ª–∏,
    –≤—Ç–æ—Ä–∞—è –¥–ª—è –æ—Ç–∫–∞–∑–∞ –≤ –≤—ã–¥–∞—á–µ —Ä–æ–ª–∏ '–°—Ç–∞—Ä—à–∏–Ω–∞'

    Attributes:
        nickname: Discord - –ø—Å–µ–≤–¥–æ–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        embed: Embed –æ–±—ä–µ–∫—Ç, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
        user: User –æ–±—ä–µ–∫—Ç –∏–∑ discord.Interaction.
    """

    def __init__(
            self,
            nickname: str,
            embed: discord.Embed,
            user: discord.Interaction.user,
            timeout: float | None = None
    ):
        super().__init__(timeout=timeout)
        self.nickname = nickname
        self.user = user
        self.embed = embed

    @button(label='–í—ã–¥–∞—Ç—å —Å—Ç–∞—Ä—à–∏–Ω—É', style=discord.ButtonStyle.green)
    async def callback_accept(
        self,
        button: discord.ui.Button,
        interaction: discord.Interaction
    ):
        """–ö–Ω–æ–ø–∫–∞ –≤—ã–¥–∞—á–∏ —Ä–æ–ª–∏ '–°—Ç–∞—Ä—à–∏–Ω–∞'."""
        if not has_required_role(interaction.user):
            await answer_if_no_role(interaction)

        role_sergeant = discord.utils.get(
            interaction.guild.roles, name='–°—Ç–∞—Ä—à–∏–Ω–∞'
        )
        role_guest = discord.utils.get(
            interaction.guild.roles, name='–ì–æ—Å—Ç—å'
        )

        # try –¥–ª—è –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ª–æ–≤–∏—Ç—å –ø–æ–∫–∞ –Ω–µ–ø–æ–Ω—è—Ç–Ω—É—é –¥–ª—è –º–µ–Ω—è –æ—à–∏–±–∫—É
        try:
            # –ó–∞—â–∏—Ç–∞ –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
            # –Ω–∞ –∫–Ω–æ–ø–∫—É 2-–º—è –∏ –±–æ–ª–µ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
            if self.nickname not in app_list:
                await interaction.respond(
                    ANSWER_IF_CLICKED_THE_SAME_TIME,
                    ephemeral=True,
                    delete_after=15
                )
            else:
                await self.user.edit(nick=self.nickname)
                await self.user.add_roles(role_sergeant)
                await self.user.remove_roles(role_guest)
                self.embed.add_field(
                    name='_–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è_ ‚úî',
                    value=f'_{interaction.user.mention} –≤—ã–¥–∞–ª —Ä–æ–ª—å!_',
                    inline=False
                )
                # –°–ø–µ—Ä–≤–∞ –±—ã–ª–∞ –∑–∞–¥—É–º–∫–∞ –ø—Ä–æ—Å—Ç–æ disabl–∏—Ç—å –∫–Ω–æ–ø–∫–∏ –∏ –≤—ã–≤–æ–¥–∏—Ç—å –∏—Ö,
                # –Ω–æ –ø–æ—Ç–æ–º —Ä–µ—à–∏–ª —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫,
                # —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ —É–±–∏—Ä–∞–ª–∏—Å—å –ø–æ—Å–ª–µ –≤—ã–¥–∞—á–∏ —Ä–æ–ª–∏
                self.disable_all_items()
                self.clear_items()
                await interaction.response.edit_message(
                    embed=self.embed,
                    view=self
                )
                await self.user.send(embed=access_embed())
                app_list.remove(self.nickname)
        # —Ç–∞ —Å–∞–º–∞—è –æ—à–∏–±–∫–∞, –ø–æ—è–≤–ª—è–ª–∞—Å—å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ –∏ —Ä–µ–¥–∫–æ (–ø—Ä–∏—á–∏–Ω–∞ –Ω–µ —è—Å–Ω–∞)
        except discord.errors.NotFound:
            await interaction.respond(
                CATCH_BUG_MESSAGE,
                ephemeral=True,
                delete_after=10
            )

    @button(
        label='–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –õ–°, —á—Ç–æ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç',
        style=discord.ButtonStyle.red
    )
    async def callback_denied(
        self,
        button: discord.ui.Button,
        interaction: discord.Interaction
    ):
        """–ö–Ω–æ–ø–∫–∞ –æ—Ç–∫–∞–∑–∞ –≤ –≤—ã–¥–∞—á–µ –≤—ã–¥–∞—á–∏ —Ä–æ–ª–∏ '–°—Ç–∞—Ä—à–∏–Ω–∞'."""
        if not has_required_role(interaction.user):
            await answer_if_no_role(interaction)
        try:
            await interaction.response.send_modal(DeniedRoleModal(
                nickname=self.nickname,
                view=self,
                user=self.user,
                embed=self.embed
            ))
        except discord.errors.NotFound:
            await interaction.respond(
                CATCH_BUG_MESSAGE,
                ephemeral=True,
                delete_after=10
            )


class DeniedRoleModal(Modal):
    """–ö–ª–∞—Å—Å –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ Discord.
    –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ, –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–∫–∞–∑–∞ –≤ –≤—ã–¥–∞—á–µ —Ä–æ–ª–∏ '–°—Ç–∞—Ä—à–∏–Ω–∞'.

    Attributes:
        nickname: Discord –Ω–∏–Ω–∫–Ω–µ–π–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        user: User –æ–±—ä–µ–∫—Ç –∏–∑ discord.Interaction.
        view: View –æ–±—ä–µ–∫—Ç –∏–∑ discord.ui.Button.
        embed: Embed –æ–±—ä–µ–∫—Ç, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
    """

    def __init__(
        self,
        nickname: str,
        user: discord.Interaction.user,
        view: discord.ui.Button,
        embed: discord.Embed,
        *args,
        **kwargs
    ):
        super().__init__(*args, **kwargs, title='–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ—Ç–∫–∞–∑—É')
        self.nickname = nickname
        self.user = user
        self.view = view
        self.embed = embed
        self.add_item(
                InputText(
                    style=discord.InputTextStyle.multiline,
                    label='–ü–æ—á–µ–º—É —Ä–µ—à–∏–ª –æ—Ç–∫–∞–∑–∞—Ç—å –≤ –∑–∞—è–≤–∫–µ',
                    placeholder=(
                        '–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ (–µ—Å–ª–∏ –ø—É—Å—Ç–æ, –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –¥—ç—Ñ–æ–ª—Ç —Ñ—Ä–∞–∑–∞)'
                    ),
                    max_length=400,
                    required=False
                )
            )

    async def callback(self, interaction: discord.Interaction):
        user = interaction.user
        value = self.children[0].value
        self.embed.add_field(
                name='_–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è_ ‚ùå',
                value=f'_{interaction.user.mention} –æ—Ç–∫–∞–∑–∞–ª –≤ –¥–æ—Å—Ç—É–ø–µ!_',
                inline=False
            )
        if self.nickname not in app_list:
            await interaction.respond(
                ANSWER_IF_CLICKED_THE_SAME_TIME,
                ephemeral=True,
                delete_after=15
            )
        else:
            app_list.remove(self.nickname)
            await self.user.send(embed=denied_embed(user, value))
            self.view.disable_all_items()
            self.view.clear_items()
            await interaction.response.edit_message(embed=self.embed, view=self.view)


class RoleApplication(Modal):
    """–ö–ª–∞—Å—Å –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ Discord.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –ø–æ–ª–µ–º –¥–ª—è –≤–≤–æ–¥–∞ –Ω–∏–∫–Ω–µ–π–º–∞.

    Attributes:
        channel: –û–±—ä–µ–∫—Ç discord.TextChannel.
    """

    def __init__(self, channel: discord.TextChannel, *args, **kwargs):
        super().__init__(*args, **kwargs, title='–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–¥–∞—á—É —Ä–æ–ª–∏')
        self.channel = channel

        self.add_item(
            InputText(
                label='–£–∫–∞–∂–∏ —Å–≤–æ–π –∏–≥—Ä–æ–≤–æ–π –Ω–∏–∫ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤',
                placeholder='–£—á–∏—Ç—ã–≤–∞–π —Ä–µ–≥–∏—Å—Ç—Ä (–±–æ–ª—å—à–∏–µ –∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –±—É–∫–≤—ã)'
            )
        )

    async def callback(self, interaction: discord.Interaction):
        nickname: str = self.children[0].value
        user = interaction.user
        member = discord.utils.get(interaction.guild.members, id=user.id)
        member_by_display_name = discord.utils.get(
            interaction.guild.members, display_name=nickname
        )
        role = discord.utils.get(interaction.guild.roles, name='–ì–æ—Å—Ç—å')
        player_parms = character_lookup(1, nickname)
        if not player_parms:
            return await interaction.respond(
                ANSWER_IF_CHEAT,
                ephemeral=True,
                delete_after=15
            )
        if nickname in app_list:
            return await interaction.respond(
                ANSWER_IF_DUPLICATE_APP,
                ephemeral=True,
                delete_after=10
            )
        if member_by_display_name:
            if role not in member_by_display_name.roles:
                return await interaction.respond(
                    ANSWER_IF_DUPLICATE_NICK,
                    ephemeral=True,
                    delete_after=10
                )

        description = (
            f'–ü—Ä–æ—Ñ–∏–ª—å Discord: {user.mention}\n'
            f'–ì–∏–ª—å–¥–∏—è: {player_parms['guild']}'
        )

        if 'dragon_emblem' in player_parms:
            description += f'\n–î—Ä–∞–∫–æ–Ω–∏–π –∞–º—É–ª–µ—Ç: {player_parms['dragon_emblem']['name']}'

        await interaction.respond(
            'üëç\n_–¢–≤–æ–π –∑–∞–ø—Ä–æ—Å –ø—Ä–∏–Ω—è—Ç! –î–æ–∂–¥–∏—Å—å –≤—ã–¥–∞—á–∏ —Ä–æ–ª–∏_',
            ephemeral=True,
            delete_after=10
        )
        await self.channel.send(
            view=RoleButton(
                nickname=nickname,
                user=user,
                embed=application_embed(
                    description, nickname, member, player_parms
                )
            ),
            embed=application_embed(
                description, nickname, member, player_parms
            )
        )
        app_list.append(nickname)


class ApplicationButton(View):
    """–ö–ª–∞—Å—Å –∫–Ω–æ–ø–∫–∏ —Ä–æ–ª–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ Discord.
    –°–æ–∑–¥–∞—ë—Ç 2 –∫–Ω–æ–ø–∫–∏. –ü–µ—Ä–≤–∞—è –¥–ª—è –≤—ã–¥–∞—á–∏ —Ä–æ–ª–∏,
    –≤—Ç–æ—Ä–∞—è –¥–ª—è –æ—Ç–∫–∞–∑–∞ –≤ –≤—ã–¥–∞—á–µ —Ä–æ–ª–∏ '–°—Ç–∞—Ä—à–∏–Ω–∞'

    Attributes:
        channel: –û–±—ä–µ–∫—Ç discord.TextChannel.
    """

    def __init__(
            self,
            channel: discord.TextChannel,
            timeout: float | None = None
    ):
        super().__init__(timeout=timeout)
        self.channel = channel

    @button(label='–ó–∞–ø–æ–ª–Ω–∏ —Ñ–æ—Ä–º—É', style=discord.ButtonStyle.green, emoji='üìã')
    async def callback(
        self,
        button: discord.ui.Button,
        interaction: discord.Interaction
    ):
        await interaction.response.send_modal(RoleApplication(
            channel=self.channel
        ))


@commands.slash_command()
@commands.has_any_role(LEADER_ROLE, TREASURER_ROLE, OFICER_ROLE)
async def role_application(
    ctx: discord.ApplicationContext,
    channel: discord.Option(
        discord.TextChannel,
        description='–í—ã–±–µ—Ä–∏ –∫–∞–Ω–∞–ª –≤ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –∑–∞—è–≤–∫–∏',
        name_localizations={'ru': '–Ω–∞–∑–≤–∞–Ω–∏–µ_–∫–∞–Ω–∞–ª–∞'}
    )  # type: ignore
):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –≤—ã–∑–æ–≤–∞ –∫–Ω–æ–ø–∫–∏, –∫–æ—Ç–æ—Ä–∞—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –¥–æ—Å—Ç—É–ø.

    Args:
        ctx: –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ discord.ApplicationContext.
        channel: –û–±—ä–µ–∫—Ç discord.TextChannel.
    """
    await ctx.respond(
        embed=start_app_embed(),
        view=ApplicationButton(channel=channel)
    )


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –≤—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è
# –æ –∑–∞–ø—Ä–µ—Ç–µ –≤—ã–∑–æ–≤–∞ –∫–æ–º–∞–Ω–¥—ã –±–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ä–æ–ª–∏
@role_application.error
async def role_application_error(
    ctx: discord.ApplicationContext,
    error: Exception
):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏, –≤–æ–∑–Ω–∏–∫–∞—é—â–∏–µ
    –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≤—ã–¥–∞—á—É –¥–æ—Å—Ç—É–ø–∞.

    Args:
        ctx: –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ discord.ApplicationContext.
        error: –í—ã–±—Ä–∞—Å—ã–≤–∞–µ–º–∞—è –æ—à–∏–±–∫–∞.
    """
    if isinstance(error, commands.errors.MissingAnyRole):
        await ctx.respond(
            '–ö–æ–º–∞–Ω–¥—É –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ "–õ–∏–¥–µ—Ä", "–ö–∞–∑–Ω–∞—á–µ–π" –∏–ª–∏ "–û—Ñ–∏—Ü–µ—Ä"!',
            ephemeral=True,
            delete_after=10
        )
    elif isinstance(error, commands.errors.PrivateMessageOnly):
        await ctx.respond(
            '–ö–æ–º–∞–Ω–¥—É –Ω–µ–ª—å–∑—è –≤—ã–∑—ã–≤–∞—Ç—å –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞!',
            ephemeral=True,
            delete_after=10
        )
    else:
        raise error


def setup(bot: discord.Bot):
    bot.add_application_command(role_application)
